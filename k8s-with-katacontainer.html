<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="SgcsMbvcduiAp6Ck7yLI77kPJXONXRYQnbXir7oefRs">

















  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/uploads/favicon-48x48.ico?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32.ico?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16.ico?v=6.4.1">


  <link rel="mask-icon" href="/uploads/favicon-48x48.ico?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.4.1',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: 'SBFCV05R39',
      apiKey: '',
      indexName: 'my hexo search',
      hits: {"per_page":10},
      labels: {"input_placeholder":"请输入关键词","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="K8S 搭配 Kata container">
<meta name="keywords" content="k8s,kata container">
<meta property="og:type" content="article">
<meta property="og:title" content="K8S搭配Kata container">
<meta property="og:url" content="https://louielong.github.io/k8s-with-katacontainer.html">
<meta property="og:site_name" content="Louie&#39;s Blog">
<meta property="og:description" content="K8S 搭配 Kata container">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/louielong/blogPic/master/imgcontainer-security.png">
<meta property="og:image" content="https://raw.githubusercontent.com/louielong/blogPic/master/imgkata_banner.png">
<meta property="og:image" content="https://raw.githubusercontent.com/louielong/blogPic/master/imgdocker_call_stack.png">
<meta property="og:image" content="https://raw.githubusercontent.com/louielong/blogPic/master/imgthumbnail.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/louielong/blogPic/master/imgkatacontainers_architecture_diagram.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/louielong/blogPic/master/imgcrio-logo.svg">
<meta property="og:updated_time" content="2020-07-24T09:50:48.433Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="K8S搭配Kata container">
<meta name="twitter:description" content="K8S 搭配 Kata container">
<meta name="twitter:image" content="https://raw.githubusercontent.com/louielong/blogPic/master/imgcontainer-security.png">



  <link rel="alternate" href="/atom.xml" title="Louie's Blog" type="application/atom+xml">




  <link rel="canonical" href="https://louielong.github.io/k8s-with-katacontainer.html">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>K8S搭配Kata container | Louie's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Louie's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">O ever youthful, O ever powerful.</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">
    <a href="/404/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://louielong.github.io/k8s-with-katacontainer.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Author">
      <meta itemprop="description" content="一只会说666的程序媛鼓励师">
      <meta itemprop="image" content="/uploads/shadian.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Louie's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">K8S搭配Kata container
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-07-20 16:47:56" itemprop="dateCreated datePublished" datetime="2020-07-20T16:47:56+08:00">2020-07-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-07-24 17:50:48" itemprop="dateModified" datetime="2020-07-24T17:50:48+08:00">2020-07-24</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/K8S/" itemprop="url" rel="index"><span itemprop="name">K8S</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/k8s-with-katacontainer.html" class="leancloud_visitors" data-flag-title="K8S搭配Kata container">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度：</span>
               
                 <span class="leancloud-visitors-count"></span>
                 
                 <span>℃</span>
                 
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">19k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">0:17</span>
              
            </div>
          

          
          
            <div class="out-img-topic">
             <img src="https://raw.githubusercontent.com/louielong/blogPic/master/imgkata-containers-compared-to-docker-kubernetes.png" class="img-topic">
            </div>
          
          

          
              <div class="post-description">K8S 搭配 Kata container</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>工作中有聊到容器安全相关的话题，专门研究了一下容器安全见上一篇博文<a href="container-security.html">Docker容器安全性分析</a>，文章详尽的分析了容器相关的安全如图所示：</p>
<p><img src="https://raw.githubusercontent.com/louielong/blogPic/master/imgcontainer-security.png" alt="容器安全"></p>
<p>针对其中的容器逃逸问题，之前关注过Openstack的一个项目<a href="https://katacontainers.io/" target="_blank" rel="noopener">Kata container</a>项目：</p>
<p><img src="https://raw.githubusercontent.com/louielong/blogPic/master/imgkata_banner.png" alt="kata container"></p>
<blockquote>
<p>Kata container是一个开源社区，致力于使用轻量级虚拟机构建安全的容器运行时，这些虚拟机感觉和执行起来都像容器，但是使用硬件虚拟化技术作为第二层防御，提供更强的工作负载隔离。</p>
</blockquote>
<p><strong>上一次部署k8s还是去年使用的是v1.17版本，这次打算重新安装一次k8s v1.18版本并搭配kata container试验一下。</strong></p>
<h2 id="二、Docker"><a href="#二、Docker" class="headerlink" title="二、Docker"></a>二、Docker</h2><p>这里简要介绍一下docker的组件，为后续的kata containe做一个铺垫。</p>
<p>docker在 1.11 之 后，被拆分成了多个组件以适应 OCI 标准。拆分之后，其包括 docker daemon，  containerd，containerd-shim 以及 runC。组件 containerd 负责集群节点上容器 的生命周期管理，并向上为  docker daemon 提供 gRPC 接口。</p>
<img src="https://raw.githubusercontent.com/louielong/blogPic/master/imgdocker_call_stack.png" alt="docker 架构" style="zoom:33%;">

<ol>
<li>dockerd 是docker-containerd 的父进程， docker-containerd 是n个docker-containerd-shim 的父进程。</li>
<li>Containerd 是一个 gRPC 的服务器。它会在接到 docker daemon 的远程请 求之后，新建一个线程去处理这次请求。依靠 runC 去创建容器进程。而在容器启动之后， runC 进程会退出。</li>
<li>runC 命令，是 libcontainer 的一个简单的封装。这个工具可以 用来管理单个容器，比如容器创建，或者容器删除。</li>
</ol>
<p>container-shim，shim的翻译是垫片，就是修自行车的时候，用来夹在螺丝和螺母之间的小铁片。关于shim本身，网上介绍的文章很少，但是作者在 <a href="https://groups.google.com/forum/#!topic/docker-dev/zaZFlvIx1_k" target="_blank" rel="noopener">Google Groups 里有解释到shim的作用</a>[2]：</p>
<ul>
<li>允许runc在创建&amp;运行容器之后退出</li>
<li>用shim作为容器的父进程，而不是直接用containerd作为容器的父进程，是为了防止这种情况：当containerd挂掉的时候，shim还在，因此可以保证容器打开的文件描述符不会被关掉</li>
<li>依靠shim来收集&amp;报告容器的退出状态，这样就不需要containerd来wait子进程</li>
</ul>
<p>关于docker组件的详细介绍这里不再赘述了，想深入了解可以查看[2]。主要关注的是<code>runc</code>，后续的kata containe也主要是替换<code>runc</code>为Hyper的<code>runv</code>。</p>
<h2 id="三、kata-container"><a href="#三、kata-container" class="headerlink" title="三、kata container"></a>三、kata container</h2><p>Kata container使用的是<code>Rust</code>语言编写，特性如下：</p>
<ul>
<li><p>安全：运行在专用的内核中，提供网络、I/O和内存隔离，可以利用虚拟化VT扩展中的硬件强制隔离。</p>
</li>
<li><p>兼容：支持行业标准，包括OCI容器格式、Kubernetes CRI接口以及传统虚拟化技术。</p>
</li>
<li><p>性能：提供与标准Linux容器一致的性能;增强了隔离性，没有标准虚拟机的性能负担。</p>
</li>
<li><p>简单：消除了在完整的虚拟机内部嵌套容器的要求； 标准接口使插入和入门变得容易。</p>
</li>
</ul>
<p>kata container基于轻量级虚拟机的容器，不同容器跑在一个个不同的虚拟机（kernel）上，比起传统容器提供了更好的隔离性和安全性，同时继承了容器快速启动和快速部署等优点。这也是本次想使用kata 的原因，能够提供比原生docker更好的隔离性，<strong>Kata 容器每个容器都使用专有内核，避免容器逃逸后影响宿主机的内核</strong>。</p>
<img src="https://raw.githubusercontent.com/louielong/blogPic/master/imgthumbnail.jpg" alt="kata container与VM的区别" style="zoom:50%;">

<img src="https://raw.githubusercontent.com/louielong/blogPic/master/imgkatacontainers_architecture_diagram.jpg" style="zoom: 33%;">

<p>废话不多说，开始体验一下kata</p>
<h3 id="3-1-安装kata"><a href="#3-1-安装kata" class="headerlink" title="3.1  安装kata"></a>3.1  安装kata</h3><p>这里使用ubuntu 18.04安装kata最新的版本<code>Kata Container 1.12.0</code>参考kata官方安装手册[3]</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ ARCH=$(arch)</span><br><span class="line">admin@k8smaster:~$ BRANCH="$&#123;BRANCH:-master&#125;"</span><br><span class="line">admin@k8smaster:~$ sudo sh -c "echo 'deb http://download.opensuse.org/repositories/home:/katacontainers:/releases:/$&#123;ARCH&#125;:/$&#123;BRANCH&#125;/xUbuntu_$(lsb_release -rs)/ /' &gt; /etc/apt/sources.list.d/kata-containers.list"</span><br><span class="line">xdnsadmin@k8smaster:~$ curl -sL  http://download.opensuse.org/repositories/home:/katacontainers:/releases:/$&#123;ARCH&#125;:/$&#123;BRANCH&#125;/xUbuntu_$(lsb_release -rs)/Release.key | sudo apt-key add -</span><br><span class="line">OK</span><br><span class="line">xdnsadmin@k8smaster:~$ sudo -E apt-get update &amp;&amp; sudo -E apt-get -y install kata-runtime kata-proxy kata-shim</span><br></pre></td></tr></table></figure>

<p>安装完成后测试一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kata-runtime --version</span><br><span class="line">kata-runtime  : 1.12.0-alpha0</span><br><span class="line">   commit   : &lt;&lt;unknown&gt;&gt;</span><br><span class="line">   OCI specs: 1.0.1-dev</span><br></pre></td></tr></table></figure>

<h3 id="3-2-配置docker的runtime"><a href="#3-2-配置docker的runtime" class="headerlink" title="3.2 配置docker的runtime"></a>3.2 配置docker的runtime</h3><p>为了保持安装的docker能够使用，这里默认仍然使用<code>runc</code>，但是增加<code>kata-runtime</code>做为可选的docker runtime。相关配置可参考官网<a href="https://github.com/kata-containers/kata-containers/tree/2.0-dev/docs/install" target="_blank" rel="noopener">kata install</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ sudo mkdir -p /etc/systemd/system/docker.service.d/</span><br><span class="line">admin@k8smaster:~$  cat &lt;&lt;EOF | sudo tee /etc/systemd/system/docker.service.d/kata-containers.conf</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/dockerd -D --default-runtime runc --add-runtime kata-runtime=/usr/bin/kata-runtime</span><br><span class="line">EOF</span><br><span class="line">admin@k8smaster:~$ sudo systemctl daemon-reload</span><br><span class="line">admin@k8smaster:~$ sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>下面创建两个容器，一个使用 kata runtime，另一个使用默认的 runc。创建完容器之后，查看一下 kata container 的一些信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ docker run -d --name kata-test -p 8080:80 --runtime kata-runtime httpd:alpine</span><br><span class="line">ddbd72466c4ce862891538a8252a83450435b25f488cce98c9f8f9a8e51711e7</span><br><span class="line">admin@k8smaster:~$ curl http://localhost:8080</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br><span class="line">admin@k8smaster:~$ docker run -d --name runc-test -p 8082:80  httpd:alpine</span><br><span class="line">c7aff63e2d239ea0d27641398f0d3f108999ba3a125c6cef9f1330ccb75c93d4</span><br><span class="line">admin@k8smaster:~$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND              CREATED              STATUS              PORTS                  NAMES</span><br><span class="line">c7aff63e2d23        httpd:alpine        "httpd-foreground"   3 seconds ago        Up 2 seconds        0.0.0.0:8082-&gt;80/tcp   runc-test</span><br><span class="line">ddbd72466c4c        httpd:alpine        "httpd-foreground"   About a minute ago   Up About a minute   0.0.0.0:8080-&gt;80/tcp   kata-test</span><br><span class="line"></span><br><span class="line">sadmin@k8smaster:~$ ps -ef | grep docker | grep runtime | grep -v dockerd</span><br><span class="line">root     31346  1035  0 08:30 ?        00:00:00 containerd-shim -namespace moby -workdir /var/lib/containerd/io.containerd.runtime.v1.linux/moby/ddbd72466c4ce862891538a8252a83450435b25f488cce98c9f8f9a8e51711e7 -address /run/containerd/containerd.sock -containerd-binary /usr/bin/containerd -runtime-root /var/run/docker/runtime-kata-runtime</span><br><span class="line">root     32169  1035  0 08:31 ?        00:00:00 containerd-shim -namespace moby -workdir /var/lib/containerd/io.containerd.runtime.v1.linux/moby/c7aff63e2d239ea0d27641398f0d3f108999ba3a125c6cef9f1330ccb75c93d4 -address /run/containerd/containerd.sock -containerd-binary /usr/bin/containerd -runtime-root /var/run/docker/runtime-runc</span><br><span class="line"></span><br><span class="line">root@k8smaster:/home/xdnsadmin# kata-runtime list    # 需要root权限</span><br><span class="line">ID                                                                 PID         STATUS      BUNDLE                     CREATED                          OWNER</span><br><span class="line">a5468f62e87ea88889d8773247d8b7863f6c8de13fc0a2c6b65ed987fa04db77   23146       running     /run/containers/storage/overlay-containers/a5468f62e87ea88889d8773247d8b7863f6c8de13fc0a2c6b65ed987fa04db77/userdata   2020-07-23T08:14:18.253804592Z   #0</span><br></pre></td></tr></table></figure>

<p>查看一下两个容器的内核版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ docker exec -it kata-test sh</span><br><span class="line">/usr/local/apache2 # uname -a</span><br><span class="line">Linux ddbd72466c4c 5.4.32-49.container #1 SMP Fri Jul 3 05:36:39 UTC 2020 x86_64 Linux</span><br><span class="line">/usr/local/apache2 # cat /proc/version</span><br><span class="line">Linux version 5.4.32-49.container (abuild@lamb04) (gcc version 7.3.0 (Ubuntu 7.3.0-16ubuntu3)) #1 SMP Fri Jul 3 05:36:39 UTC 2020</span><br><span class="line"></span><br><span class="line">admin@k8smaster:~$ docker exec -it runc-test sh</span><br><span class="line">/usr/local/apache2 # uname -a    # runc容器内核</span><br><span class="line">Linux c7aff63e2d23 4.15.0-112-generic #113-Ubuntu SMP Thu Jul 9 23:41:39 UTC 2020 x86_64 Linux</span><br><span class="line"></span><br><span class="line">admin@k8smaster:~$ uname -a  #宿主机内核</span><br><span class="line">Linux ubuntu 4.15.0-112-generic #113-Ubuntu SMP Thu Jul 9 23:41:39 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p>查看一下kata容器的虚拟机，可以看到kata专门给容器启动了一个虚拟机沙盒</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$  ps -ef | grep qemu | grep -v 'grep'</span><br><span class="line">root     31390 31346  0 08:30 ?        00:00:03 /usr/bin/qemu-vanilla-system-x86_64 -name sandbox-ddbd72466c4ce862891538a8252a83450435b25f488cce98c9f8f9a8e51711e7 -uuid 0cbfc946-2979-4f44-9d82-62dcdb673c0a -machine pc,accel=kvm,kernel_irqchip,nvdimm -cpu host,pmu=off -qmp unix:/run/vc/vm/ddbd72466c4ce862891538a8252a83450435b25f488cce98c9f8f9a8e51711e7/qmp.sock,server,nowait -m 2048M,slots=10,maxmem=8995M -device pci-bridge,bus=pci.0,id=pci-bridge-0,chassis_nr=1,shpc=on,addr=2,romfile= -device virtio-serial-pci,disable-modern=true,id=serial0,romfile= -device virtconsole,chardev=charconsole0,id=console0 -chardev socket,id=charconsole0,path=/run/vc/vm/ddbd72466c4ce862891538a8252a83450435b25f488cce98c9f8f9a8e51711e7/console.sock,server,nowait -device nvdimm,id=nv0,memdev=mem0 -object memory-backend-file,id=mem0,mem-path=/usr/share/kata-containers/kata-containers-image_clearlinux_1.12.0-alpha0_agent_e01f289887.img,size=134217728 -device virtio-scsi-pci,id=scsi0,disable-modern=true,romfile= -object rng-random,id=rng0,filename=/dev/urandom -device virtio-rng-pci,rng=rng0,romfile= -device virtserialport,chardev=charch0,id=channel0,name=agent.channel.0 -chardev socket,id=charch0,path=/run/vc/vm/ddbd72466c4ce862891538a8252a83450435b25f488cce98c9f8f9a8e51711e7/kata.sock,server,nowait -device virtio-9p-pci,disable-modern=true,fsdev=extra-9p-kataShared,mount_tag=kataShared,romfile= -fsdev local,id=extra-9p-kataShared,path=/run/kata-containers/shared/sandboxes/ddbd72466c4ce862891538a8252a83450435b25f488cce98c9f8f9a8e51711e7/shared,security_model=none -netdev tap,id=network-0,vhost=on,vhostfds=3,fds=4 -device driver=virtio-net-pci,netdev=network-0,mac=02:42:ac:11:00:04,disable-modern=true,mq=on,vectors=4,romfile= -rtc base=utc,driftfix=slew,clock=host -global kvm-pit.lost_tick_policy=discard -vga none -no-user-config -nodefaults -nographic -daemonize -object memory-backend-ram,id=dimm1,size=2048M -numa node,memdev=dimm1 -kernel /usr/share/kata-containers/vmlinuz-5.4.32.80-49.container -append tsc=reliable no_timer_check rcupdate.rcu_expedited=1 i8042.direct=1 i8042.dumbkbd=1 i8042.nopnp=1 i8042.noaux=1 noreplace-smp reboot=k console=hvc0 console=hvc1 cryptomgr.notests net.ifnames=0 pci=lastbus=0 iommu=off root=/dev/pmem0p1 rootflags=dax,data=ordered,errors=remount-ro ro rootfstype=ext4 quiet systemd.show_status=false panic=1 nr_cpus=4 agent.use_vsock=false systemd.unit=kata-containers.target systemd.mask=systemd-networkd.service systemd.mask=systemd-networkd.socket scsi_mod.scan=none -pidfile /run/vc/vm/ddbd72466c4ce862891538a8252a83450435b25f488cce98c9f8f9a8e51711e7/pid -smp 1,cores=1,threads=1,sockets=4,maxcpus=4</span><br></pre></td></tr></table></figure>

<h3 id="3-3-配置k8s与kata的集成"><a href="#3-3-配置k8s与kata的集成" class="headerlink" title="3.3 配置k8s与kata的集成"></a>3.3 配置k8s与kata的集成</h3><p>kata 不直接与 k8s 通信，因为对于 k8s 来说，它只跟实现了 CRI 接口的容器管理进程打交道，比如  docker-engine，rkt, containerd(使用 cri plugin) 或 CRI-O，而 kata 跟 runc  是同一个级别的进程。所以如果要与 k8s 集成，则需要安装 CRI-O 或 CRI-containerd 来支持 CRI 接口，本文使用  CRI-O。CRI-O 的 O 的意思是 OCI-compatible，即 CRI-O 是实现 CRI 接口来跑 OCI 容器的[4]。</p>
<p>由于ubuntu 18.04 的<a href="http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_18.04/" target="_blank" rel="noopener">suse源</a>中含有相关软件的包，这里展示如何直接用apt快速安装体验，相关软件的版本如表3.1所示</p>
<p>表3.1  相关软件版本</p>
<table>
<thead>
<tr>
<th>软件名</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>kubelet、kubeadm、kubectl</td>
<td>1.18.6</td>
</tr>
<tr>
<td>cri-o</td>
<td>1.17</td>
</tr>
<tr>
<td>kata</td>
<td>1.12-alpha0</td>
</tr>
</tbody></table>
<h4 id="3-3-1-安装-cri-o"><a href="#3-3-1-安装-cri-o" class="headerlink" title="3.3.1 安装 cri-o"></a>3.3.1 安装 cri-o</h4><p>CRI-O - OCI-based implementation of Kubernetes Container Runtime Interface<br>这是<a href="https://github.com/cri-o/cri-o" target="_blank" rel="noopener">cri-o</a>的github标题，符合OCI基准实现的Kubernetes容器运行时接口，从这个标题很容易看出，这是一个专门服务k8s的容器实现。</p>
<ul>
<li>CRI Container Runtime  Interface这是k8s提出的一个概念，在容器界除了最出名的docker和本文介绍的cri-o，还有很多不同的容器实现，例如contrainerd, frakti，rkt等，这些容器实现各有特色，只要支持CRI就可以被k8s支持</li>
<li>OCI Open Container  Initiative这是开放容器标准，也叫容器runtime，简单来说只要符合这个标准运行的就是容器，例如runC，Kata，gVisor这些runtime创建出来的都是OCI标准容器容器标准，也叫容器runtime，简单来说只要符合这个标准运行的，就是容器，例如runC，Kata，gVisor这些runtime创建出来的都是OCI标准容器</li>
</ul>
<p><img src="https://raw.githubusercontent.com/louielong/blogPic/master/imgcrio-logo.svg" alt="cri-o logo"></p>
<p>1）安装cri-o</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ CRIO_VERSION=1.17   # 当前ubuntu只有1.17</span><br><span class="line">admin@k8smaster:~$ . /etc/os-release</span><br><span class="line">admin@k8smaster:~$ sudo sh -c "echo 'deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/x$&#123;NAME&#125;_$&#123;VERSION_ID&#125;/ /' &gt;/etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list"</span><br><span class="line">admin@k8smaster:~$ wget -nv https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable/x$&#123;NAME&#125;_$&#123;VERSION_ID&#125;/Release.key -O- | sudo apt-key add -</span><br><span class="line">admin@k8smaster:~$ sudo apt-get update -qq</span><br><span class="line">admin@k8smaster:~$ sudo apt-get install cri-o-$&#123;CRIO_VERSION&#125;</span><br></pre></td></tr></table></figure>

<p>2）修改crio配置文件<code>/etc/crio/crio.conf</code>，增加kata runtime</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ sudo vim /etc/crio/crio.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 设置kata-runtime为容器运行时</span><br><span class="line">[crio.runtime.runtimes.kata-runtime]</span><br><span class="line">runtime_path = "/usr/bin/kata-runtime"</span><br><span class="line">runtime_type = "oci"</span><br><span class="line">runtime_root = ""</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 由于k8s.gcr.io 无法访问的原因修改镜像源</span><br><span class="line">pause_image = "registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 设置crio镜像下载地址</span><br><span class="line">registries = ["docker.io"]</span><br></pre></td></tr></table></figure>

<p>3）修改crio systemd配置，设置自启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ sudo vim /usr/lib/systemd/system/crio.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">....</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">admin@k8smaster:~$ sudo systemctl daemon-reload</span><br><span class="line">admin@k8smaster:~$ sudo systemctl restart crio</span><br><span class="line">admin@k8smaster:~$ sudo service crio status</span><br><span class="line">[sudo] password for louie:</span><br><span class="line">● crio.service - Container Runtime Interface for OCI (CRI-O)</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/crio.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Thu 2020-07-23 02:13:39 UTC; 6h ago</span><br><span class="line">     Docs: https://github.com/cri-o/cri-o</span><br><span class="line"> Main PID: 1876 (crio)</span><br><span class="line">    Tasks: 21</span><br><span class="line">   CGroup: /system.slice/crio.service</span><br><span class="line">           └─1876 /usr/bin/crio</span><br></pre></td></tr></table></figure>

<p>4）测试crio</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ cat /etc/crictl.yaml</span><br><span class="line">runtime-endpoint: unix:///var/run/crio/crio.sock</span><br><span class="line">image-endpoint: unix:///var/run/crio/crio.sock</span><br><span class="line">timeout: 10</span><br><span class="line"></span><br><span class="line">admin@k8smaster:~$ sudo crictl version</span><br><span class="line">Version:  0.1.0</span><br><span class="line">RuntimeName:  cri-o</span><br><span class="line">RuntimeVersion:  1.17.4</span><br><span class="line">RuntimeApiVersion:  v1alpha1</span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-安装k8s"><a href="#3-3-2-安装k8s" class="headerlink" title="3.3.2 安装k8s"></a>3.3.2 安装k8s</h4><p>1）添加k8s源并安装k8s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使得 apt 支持 ssl 传输</span></span><br><span class="line">admin@k8smaster:~$ sudo apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class="line"><span class="comment"># 下载 gpg 密钥</span></span><br><span class="line">admin@k8smaster:~$ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># 添加 k8s 镜像源</span></span><br><span class="line">admin@k8smaster:~$ sudo cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># 更新源列表</span></span><br><span class="line">admin@k8smaster:~$ sudo apt-get update</span><br><span class="line"><span class="comment"># 下载 kubectl，kubeadm以及 kubelet</span></span><br><span class="line">admin@k8smaster:~$ sudo apt-get install -y kubelet=1.18.6-00 kubeadm=1.18.6-00 kubectl=1.18.6-00</span><br></pre></td></tr></table></figure>

<p>2）配置k8s使用crio</p>
<p>根据<a href="https://github.com/cri-o/cri-o/blob/master/tutorials/kubeadm.md" target="_blank" rel="noopener">官方手册</a>，通过cri-o运行k8s需要修改相应文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ sudo cat /etc/default/kubelet</span><br><span class="line">KUBELET_EXTRA_ARGS=--feature-gates="AllAlpha=false,RunAsGroup=true" --container-runtime=remote --cgroup-driver=systemd --container-runtime-endpoint='unix:///var/run/crio/crio.sock' --runtime-request-timeout=5m</span><br></pre></td></tr></table></figure>

<p>修改kubeadm配置，修改cgroup驱动为systemd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ sudo vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">....</span><br><span class="line">Environment="KUBELET_EXTRA_ARGS=--container-runtime=remote --cgroup-driver=systemd --runtime-request-timeout=15m --container-runtime-endpoint=unix:///var/run/crio/crio.sock"</span><br></pre></td></tr></table></figure>

<p>重启kubelet</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ sudo systemctl daemon-reload; systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<p>3）初始化k8s集群</p>
<p>这里通过制定k8s容器仓库为阿里云镜像仓库避免被墙而无法下载镜像，由于阿里云的镜像与官方不同步，因此这里镜像的版本指定为<code>v1.18.0</code>，稍微与kubeadm的镜像版本<code>v1.18.6</code>不一致。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ sudo kubeadm init --image-repository=registry.aliyuncs.com/google_containers --pod-network-cidr=192.168.0.0/16 --kubernetes-version=v1.18.0 --apiserver-advertise-address=10.37.129.3 --cri-socket=/var/run/crio/crio.sock --v=5</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">admin@k8smaster:~$ mkdir -p $HOME/.kube; cp -i /etc/kubernetes/admin.conf $HOME/.kube/config; chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>--pod-network-cidr=192.168.0.0/16</code>，若于主机所在网络冲突可修改</p>
</li>
<li><p><code>--apiserver-advertise-address=10.37.129.3</code> ，可不指定API地址，本次安装为了避免网络影响，给机器新增了一块网口</p>
</li>
</ul>
<hr>
<p><strong><em>【NOTE】</em></strong></p>
<p>1）想查看k8s对应镜像版本可以通过如下命令查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kubeadm config images list</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.18.6</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.18.6</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.18.6</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.18.6</span><br><span class="line">k8s.gcr.io/pause:3.2</span><br><span class="line">k8s.gcr.io/etcd:3.4.3-0</span><br><span class="line">k8s.gcr.io/coredns:1.6.7</span><br></pre></td></tr></table></figure>

<p>对于离线情况下，亦可手动下载镜像再导入，这里推荐一个博客<a href="https://www.cnblogs.com/kcxg/p/11457209.html" target="_blank" rel="noopener">Docker/Kubernetes镜像</a>，详细介绍了如何获取<code>gcr.io</code>镜像</p>
<p>2）手动安装相关软件最新版本可参考<a href="https://lingxiankong.github.io/2018-07-20-katacontainer-docker-k8s.html" target="_blank" rel="noopener">Katacontainers 与 Docker 和 Kubernetes 的集成</a>，文中相关软件版本较老，这里列出相关软件的最新realease版本</p>
<ul>
<li><p><a href="https://github.com/opencontainers/runc/releases" target="_blank" rel="noopener">Runc release</a></p>
</li>
<li><p><a href="https://github.com/kubernetes-sigs/cri-tools/releases" target="_blank" rel="noopener">Crictl release</a></p>
</li>
<li><p><a href="https://github.com/containers/conmon" target="_blank" rel="noopener">conmon</a></p>
</li>
<li><p><a href="https://github.com/containernetworking/plugins/releases" target="_blank" rel="noopener">CNI plugins</a></p>
</li>
</ul>
<hr>
<h4 id="3-3-3-配置k8s集群网络"><a href="#3-3-3-配置k8s集群网络" class="headerlink" title="3.3.3 配置k8s集群网络"></a>3.3.3 配置k8s集群网络</h4><p>这里选用calico网络，参考<a href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart" target="_blank" rel="noopener">calico官网</a></p>
<p>1）安装Tigera Calico操作符和自定义资源定义</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml</span><br></pre></td></tr></table></figure>

<p>2）通过创建必要的自定义资源来安装Calico</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kubectl create -f https://docs.projectcalico.org/manifests/custom-resources.yaml</span><br></pre></td></tr></table></figure>

<p>这里需要注意，若k8s集群初始化时<code>CIDR</code>指定的不是<code>192.168.0.0/16</code>需要修改<code>custom-resources.yaml</code>文件中的<code>CIDR</code>地址</p>
<p>3）确认所有pod都在运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ watch kubectl get pods -n calico-system</span><br></pre></td></tr></table></figure>

<p>等待所有pod的状态为<code>running</code></p>
<p>4）本次安装只使用了一个节点，需要配置master节点“无污点”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kubectl taint nodes --all node-role.kubernetes.io/master-</span><br><span class="line">node/&lt;your-hostname&gt; untainted</span><br></pre></td></tr></table></figure>

<p>5）查看所有master节点状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kubectl get nodes -o wide</span><br><span class="line">NAME     STATUS   ROLES    AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME</span><br><span class="line">ubuntu   Ready    master   6h36m   v1.18.6   10.211.55.5   &lt;none&gt;        Ubuntu 18.04.4 LTS   4.15.0-112-generic   cri-o://1.17.4</span><br></pre></td></tr></table></figure>

<p>6）查看所有pod状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kubectl get pods -A -o wide</span><br><span class="line">NAMESPACE         NAME                                       READY   STATUS    RESTARTS   AGE     IP                NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">calico-system     calico-kube-controllers-5687f44fd5-49d4d   1/1     Running   0          6h34m   192.168.243.194   ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-system     calico-node-grtnk                          1/1     Running   0          6h34m   10.211.55.5       ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-system     calico-typha-7cd5478c69-vldhp              1/1     Running   0          6h34m   10.211.55.5       ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system       coredns-7ff77c879f-7b7lc                   1/1     Running   0          6h36m   192.168.243.192   ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system       coredns-7ff77c879f-m8glx                   1/1     Running   0          6h36m   192.168.243.195   ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system       etcd-ubuntu                                1/1     Running   0          6h36m   10.211.55.5       ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system       kube-apiserver-ubuntu                      1/1     Running   0          6h36m   10.211.55.5       ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system       kube-controller-manager-ubuntu             1/1     Running   0          6h36m   10.211.55.5       ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system       kube-proxy-mzpk5                           1/1     Running   0          6h36m   10.211.55.5       ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system       kube-scheduler-ubuntu                      1/1     Running   0          6h36m   10.211.55.5       ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">tigera-operator   tigera-operator-6659cdcd96-7nzsq           1/1     Running   0          6h35m   10.211.55.5       ubuntu   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-4-测试k8s使用kata-runtime"><a href="#3-3-4-测试k8s使用kata-runtime" class="headerlink" title="3.3.4 测试k8s使用kata runtime"></a>3.3.4 测试k8s使用kata runtime</h4><p>k8s从1.14版本开始设置了<a href="https://kubernetes.io/zh/docs/concepts/containers/runtime-class/" target="_blank" rel="noopener">runt imeclass</a> ，同时crio从1.14版本开始增加RuntimeHandler以取代<a href="https://lingxiankong.github.io/2018-07-20-katacontainer-docker-k8s.html" target="_blank" rel="noopener">trusted/untrusted runtime</a>，因此k8s使用kata不能再使用如下配置了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">        <span class="string">io.kubernetes.cri-o.TrustedSandbox:</span> <span class="string">"false"</span></span><br></pre></td></tr></table></figure>

<p>1）首先创建kata runtime class</p>
<p>编写kata runtime class配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s-runtimecleass.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1beta1</span>  <span class="comment"># RuntimeClass is defined in the node.k8s.io API group</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kata</span></span><br><span class="line"><span class="attr">handler:</span> <span class="string">kata-runtime</span>  <span class="comment"># handler 名称需要与/etc/crio/crio.conf配置一致</span></span><br></pre></td></tr></table></figure>

<p>创建kata runtime class</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kubectl apply -f k8s-runtimecleass.yaml</span><br><span class="line">admin@k8smaster:~$ kubectl get runtimeclass</span><br><span class="line">NAME   HANDLER        AGE</span><br><span class="line">kata   kata-runtime   1m</span><br></pre></td></tr></table></figure>

<p>2）创建kata runtime pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ cat kata-test.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: test-kata</span><br><span class="line">  labels:</span><br><span class="line">    app: kata</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kata</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kata</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: test-kata</span><br><span class="line">        image: lingxiankong/alpine-test</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">      runtimeClassName: kata  # 注明使用kata runtime</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: test-kata</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: kata</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 8080</span><br><span class="line"></span><br><span class="line">admin@k8smaster:~$ kubectl apply -f kata-test.yaml</span><br></pre></td></tr></table></figure>

<p>等待kata pod 启动，查看pod状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">admin@k8smaster:~$ kubectl get pod -o wide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP                NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">test-kata-64b4c55f9c-bh7xl   1/1     Running   0          25h   192.168.243.199   ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">test-kata-64b4c55f9c-cjvg7   1/1     Running   0          25h   192.168.243.198   ubuntu   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">admin@k8smaster:~$ kubectl get pod test-kata</span><br><span class="line">admin@k8smaster:~$ kubectl get deployment test-kata</span><br><span class="line">admin@k8smaster:~$ kubectl get svc test-kata</span><br></pre></td></tr></table></figure>

<p>【参考链接】</p>
<p>1）<a href="https://jiajunhuang.com/articles/2018_12_24-docker_components_part2.md.html" target="_blank" rel="noopener">Docker组件介绍（二）：shim, docker-init和docker-proxy</a></p>
<p>2）<a href="https://jiajunhuang.com/articles/2018_12_22-docker_components.md.html" target="_blank" rel="noopener">Docker组件介绍（一）：runc和containerd</a></p>
<p>3）<a href="https://github.com/kata-containers/documentation/blob/master/install/ubuntu-installation-guide.md" target="_blank" rel="noopener">Install Kata Containers on Ubuntu</a></p>
<p>4）<a href="https://lingxiankong.github.io/2018-07-20-katacontainer-docker-k8s.html" target="_blank" rel="noopener">Katacontainers 与 Docker 和 Kubernetes 的集成</a></p>

      
    </div>

    

    
    
        <div>
            
    <div blockquote class="blockquote-center" style="color: #32CD32;font-size:18px;">
    -------------本文结束<i class="fa fa-heartbeat"></i>感谢您的阅读-------------
    </div>


        </div>
    
    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/wechatpay.jpeg" alt="Author 微信支付">
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    
      
        <div>
            
<br>
<div style="border: 1px solid black">
<div style="margin-left:10px">
<span style="font-weight:blod">版权声明</span>
<img src="/uploads/cc.png">
<br>
<p style="font-size: 10px;line-height: 30px"><a href="http://ylong.net.cn" style="color:#258FC6">Louie's Blog</a> by <a href="http://ylong.net.cn" style="color:#258FC6">louie long</a> is licensed under a <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" style="color:#258FC6">Creative Commons BY-NC-ND 4.0 International License</a>.<br>
由<a href="http://ylong.net.cn" style="color:#258FC6">Louie Long</a>创作并维护的<a href="ylong.net.cn" style="color:#258FC6">Louie's Blog</a>博客采用<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" style="color:#258FC6">创作共用保留署名-非商业-禁止演绎4.0国际许可证</a>。<br>
本文首发于<a href="http://ylong.net.cn" style="color:#258FC6">Louie's Blog</a> 博客（ <a href="http://ylong.net.cn" style="color:#258FC6">http://ylong.net.cn</a> ），版权所有，侵权必究。
<br>
转载请注明作者和链接地址<a href="http://ylong.net.cn" style="color:#258FC6">http://ylong.net.cn</a>, 如对文章内容有疑问请联系邮箱（ <a style="color:#258FC6">longyu805@163.com</a> ）。</p>
</div>
</div>


        </div>
      
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/source/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          
            <a href="/source/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a>
          
            <a href="/source/tags/kata-container/" rel="tag"><i class="fa fa-tag"></i> kata container</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/k8s-cri.html" rel="next" title="【转载】扩展 Kubernetes 之 CRI">
                <i class="fa fa-chevron-left"></i> 【转载】扩展 Kubernetes 之 CRI
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/shadian.png" alt="Author">
            
              <p class="site-author-name" itemprop="name">Louie Long</p>
              <p class="site-description motion-element" itemprop="description">一只会说666的程序媛鼓励师</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/louielong" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:longyu805@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/_long__" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、前言"><span class="nav-text">一、前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Docker"><span class="nav-text">二、Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、kata-container"><span class="nav-text">三、kata container</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-安装kata"><span class="nav-text">3.1  安装kata</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-配置docker的runtime"><span class="nav-text">3.2 配置docker的runtime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-配置k8s与kata的集成"><span class="nav-text">3.3 配置k8s与kata的集成</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1-安装-cri-o"><span class="nav-text">3.3.1 安装 cri-o</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2-安装k8s"><span class="nav-text">3.3.2 安装k8s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-3-配置k8s集群网络"><span class="nav-text">3.3.3 配置k8s集群网络</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-4-测试k8s使用kata-runtime"><span class="nav-text">3.3.4 测试k8s使用kata runtime</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-ravelry"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Louie</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">278k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">4:13</span>
  

  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <span id="busuanzi_container_site_pv">
  | 本站总访问量<span style="color:#FA8072" id="busuanzi_value_site_pv"></span>次
  </span>
  <span id="busuanzi_container_site_uv">
  | 本站访客数<span style="color:#FA8072" id="busuanzi_value_site_uv"></span>人次
  </span>
  

</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Mist</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=6.4.1"></script>



  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.time + 1);
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! See more at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see here how to solve it: https://github.com/theme-next/hexo-leancloud-counter-security. \n But you also can use LeanCloud without security, by set \'security\' option to \'false\'.');
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "M8d5yPXQ5l0kwFz1bO6cF7b3-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "M8d5yPXQ5l0kwFz1bO6cF7b3-gzGzoHsz",
                'X-LC-Key': "QEarlHm5c8XcuF22TbFD3Bqn",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  

  
  

  

  

  

  

  


  
  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/src/clicklove.js"></script>
  

</body>
</html>
